#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
漏洞数据库
包含端口漏洞信息和攻击模式特征库
"""

from typing import Dict, Optional

# 导入依赖
from .security_db import SecurityDatabaseManager

class VulnerabilityDatabase:
    """漏洞数据库（增强版，集成权威数据库）"""
    
    def __init__(self, enable_online_db: bool = True):
        """初始化漏洞数据库"""
        self.enable_online_db = enable_online_db
        if enable_online_db:
            self.security_db_manager = SecurityDatabaseManager()
        else:
            self.security_db_manager = None
    
    # 扩展的漏洞端口数据库（包含CVE和常见漏洞信息）
    VULNERABLE_PORTS_DB = {
        21: {
            'service': 'FTP',
            'description': 'FTP服务（可能存在弱密码、匿名登录、CVE-2020-1938等）',
            'common_cves': ['CVE-2020-1938', 'CVE-2019-12815'],
            'attack_patterns': ['暴力破解', '匿名登录', '目录遍历'],
            'severity': 'high'
        },
        22: {
            'service': 'SSH',
            'description': 'SSH服务（可能存在弱密码、CVE-2018-15473等）',
            'common_cves': ['CVE-2018-15473', 'CVE-2016-0777', 'CVE-2016-0778'],
            'attack_patterns': ['暴力破解', '密钥泄露', '中间人攻击'],
            'severity': 'high'
        },
        23: {
            'service': 'Telnet',
            'description': 'Telnet服务（明文传输，CVE-2020-10173等）',
            'common_cves': ['CVE-2020-10173'],
            'attack_patterns': ['明文传输', '暴力破解', '会话劫持'],
            'severity': 'critical'
        },
        25: {
            'service': 'SMTP',
            'description': 'SMTP服务（可能被用于垃圾邮件、CVE-2020-7247等）',
            'common_cves': ['CVE-2020-7247', 'CVE-2019-10149'],
            'attack_patterns': ['开放中继', '垃圾邮件', '邮件欺骗'],
            'severity': 'medium'
        },
        80: {
            'service': 'HTTP',
            'description': 'HTTP服务（未加密，可能存在多种Web漏洞）',
            'common_cves': ['CVE-2021-44228', 'CVE-2021-45046', 'CVE-2017-5638'],
            'attack_patterns': ['SQL注入', 'XSS', 'CSRF', '目录遍历'],
            'severity': 'medium'
        },
        135: {
            'service': 'RPC',
            'description': 'RPC服务（Windows，CVE-2017-0144等）',
            'common_cves': ['CVE-2017-0144', 'CVE-2017-0145'],
            'attack_patterns': ['EternalBlue', '远程代码执行'],
            'severity': 'critical'
        },
        139: {
            'service': 'NetBIOS',
            'description': 'NetBIOS服务（Windows，信息泄露）',
            'common_cves': ['CVE-2017-0143'],
            'attack_patterns': ['信息泄露', '枚举攻击'],
            'severity': 'medium'
        },
        445: {
            'service': 'SMB',
            'description': 'SMB服务（Windows，CVE-2017-0144 EternalBlue等）',
            'common_cves': ['CVE-2017-0144', 'CVE-2019-0708', 'CVE-2020-0796'],
            'attack_patterns': ['EternalBlue', 'BlueKeep', 'SMBGhost', '暴力破解'],
            'severity': 'critical'
        },
        1433: {
            'service': 'MSSQL',
            'description': 'Microsoft SQL Server（可能存在弱密码、CVE-2019-1069等）',
            'common_cves': ['CVE-2019-1069', 'CVE-2018-8273'],
            'attack_patterns': ['暴力破解', 'SQL注入', '远程代码执行'],
            'severity': 'high'
        },
        3306: {
            'service': 'MySQL',
            'description': 'MySQL数据库（可能存在弱密码、CVE-2021-27928等）',
            'common_cves': ['CVE-2021-27928', 'CVE-2020-14882'],
            'attack_patterns': ['暴力破解', 'SQL注入', '权限提升'],
            'severity': 'high'
        },
        3389: {
            'service': 'RDP',
            'description': 'Windows远程桌面（CVE-2019-0708 BlueKeep等）',
            'common_cves': ['CVE-2019-0708', 'CVE-2020-0609', 'CVE-2021-34527'],
            'attack_patterns': ['BlueKeep', '暴力破解', '远程代码执行'],
            'severity': 'critical'
        },
        5432: {
            'service': 'PostgreSQL',
            'description': 'PostgreSQL数据库（可能存在弱密码、CVE-2019-9193等）',
            'common_cves': ['CVE-2019-9193', 'CVE-2018-1058'],
            'attack_patterns': ['暴力破解', 'SQL注入', '命令执行'],
            'severity': 'high'
        },
        5900: {
            'service': 'VNC',
            'description': 'VNC远程桌面（可能存在弱密码、CVE-2019-15678等）',
            'common_cves': ['CVE-2019-15678', 'CVE-2018-20753'],
            'attack_patterns': ['暴力破解', '未授权访问', '会话劫持'],
            'severity': 'high'
        },
        6379: {
            'service': 'Redis',
            'description': 'Redis数据库（可能未设置密码、CVE-2019-10192等）',
            'common_cves': ['CVE-2019-10192', 'CVE-2015-4335'],
            'attack_patterns': ['未授权访问', '命令执行', '数据泄露'],
            'severity': 'critical'
        },
        27017: {
            'service': 'MongoDB',
            'description': 'MongoDB数据库（可能未设置认证、CVE-2019-2392等）',
            'common_cves': ['CVE-2019-2392', 'CVE-2016-6494'],
            'attack_patterns': ['未授权访问', '数据泄露', '注入攻击'],
            'severity': 'critical'
        },
        8080: {
            'service': 'HTTP-Proxy',
            'description': 'HTTP代理服务（可能存在Web漏洞）',
            'common_cves': ['CVE-2021-44228'],
            'attack_patterns': ['代理滥用', 'Web漏洞'],
            'severity': 'medium'
        },
        8443: {
            'service': 'HTTPS-Alt',
            'description': 'HTTPS替代端口（可能存在SSL/TLS漏洞）',
            'common_cves': ['CVE-2014-0160', 'CVE-2014-0224'],
            'attack_patterns': ['SSL/TLS漏洞', '中间人攻击'],
            'severity': 'medium'
        },
        1434: {
            'service': 'MSSQL-UDP',
            'description': 'MSSQL UDP端口（信息泄露）',
            'common_cves': ['CVE-2000-0202'],
            'attack_patterns': ['信息泄露', '枚举攻击'],
            'severity': 'medium'
        },
        161: {
            'service': 'SNMP',
            'description': 'SNMP服务（可能存在弱密码、CVE-2018-1000115等）',
            'common_cves': ['CVE-2018-1000115', 'CVE-2017-6742'],
            'attack_patterns': ['弱密码', '信息泄露', '拒绝服务'],
            'severity': 'medium'
        },
        514: {
            'service': 'Syslog',
            'description': 'Syslog服务（可能存在信息泄露）',
            'common_cves': [],
            'attack_patterns': ['信息泄露', '日志注入'],
            'severity': 'low'
        },
        1521: {
            'service': 'Oracle',
            'description': 'Oracle数据库（可能存在弱密码、CVE-2020-14750等）',
            'common_cves': ['CVE-2020-14750', 'CVE-2019-2729'],
            'attack_patterns': ['暴力破解', 'SQL注入', '权限提升'],
            'severity': 'high'
        },
        5985: {
            'service': 'WinRM',
            'description': 'Windows远程管理（CVE-2021-38647等）',
            'common_cves': ['CVE-2021-38647', 'CVE-2019-1040'],
            'attack_patterns': ['远程代码执行', '暴力破解'],
            'severity': 'high'
        },
        5986: {
            'service': 'WinRM-HTTPS',
            'description': 'Windows远程管理HTTPS（CVE-2021-38647等）',
            'common_cves': ['CVE-2021-38647'],
            'attack_patterns': ['远程代码执行', '暴力破解'],
            'severity': 'high'
        }
    }
    
    # 攻击模式特征库
    ATTACK_PATTERNS = {
        'port_scan': {
            'description': '端口扫描攻击',
            'indicators': ['多个端口访问', '快速连续访问', '无响应连接'],
            'severity': 'medium'
        },
        'brute_force': {
            'description': '暴力破解攻击',
            'indicators': ['多次失败尝试', '同一端口重复访问', '认证失败'],
            'severity': 'high'
        },
        'dictionary_attack': {
            'description': '字典攻击',
            'indicators': ['常见密码尝试', '用户名枚举', '模式化尝试'],
            'severity': 'high'
        },
        'sql_injection': {
            'description': 'SQL注入攻击',
            'indicators': ['SQL关键字', '特殊字符', '数据库错误'],
            'severity': 'critical'
        },
        'xss': {
            'description': '跨站脚本攻击',
            'indicators': ['脚本标签', '事件处理器', '编码绕过'],
            'severity': 'high'
        },
        'dos': {
            'description': '拒绝服务攻击',
            'indicators': ['大量请求', '异常流量', '资源耗尽'],
            'severity': 'high'
        },
        'malware_c2': {
            'description': '恶意软件C2通信',
            'indicators': ['异常端口', '加密通信', '定期连接'],
            'severity': 'critical'
        }
    }
    
    def get_port_info(self, port: int) -> Optional[Dict]:
        """获取端口漏洞信息（增强版，包含在线数据库查询）"""
        port_info = VulnerabilityDatabase.VULNERABLE_PORTS_DB.get(port)
        
        if port_info and self.security_db_manager:
            # 从在线数据库获取增强信息
            cves = port_info.get('common_cves', [])
            enhanced_cves = []
            
            for cve_id in cves[:3]:  # 只查询前3个CVE以避免过多请求
                enhanced_info = self.security_db_manager.get_enhanced_vulnerability_info(cve_id, port)
                if enhanced_info.get('sources'):
                    enhanced_cves.append({
                        'cve_id': cve_id,
                        'sources': enhanced_info['sources'],
                        'cvss_score': enhanced_info['cvss_scores'][0] if enhanced_info['cvss_scores'] else None,
                        'severity': enhanced_info['severities'][0] if enhanced_info['severities'] else None,
                        'urls': enhanced_info['urls']
                    })
            
            if enhanced_cves:
                port_info = port_info.copy()
                port_info['enhanced_cves'] = enhanced_cves
        
        return port_info
    
    @staticmethod
    def get_attack_pattern(pattern_name: str) -> Optional[Dict]:
        """获取攻击模式信息"""
        return VulnerabilityDatabase.ATTACK_PATTERNS.get(pattern_name)


